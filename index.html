<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b84ff" />
  <link rel="manifest" href="/manifest.json" />
  <title>Compteur 10000 — Partie</title>
<style>
  :root {
    --bg: #f3f6fb;
    --card: #fff;
    --accent: #0b84ff;
    --muted: #6b7280;
  }
  html { overflow-x: hidden; width: 100%; max-width: 100vw; overscroll-behavior-x: none; }
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial;
    background: linear-gradient(180deg, var(--bg), #fff);
    padding: 18px;
    display: flex;
    justify-content: center;
    overflow-x: hidden;
    max-width: 100vw;
    overscroll-behavior-x: none;
    touch-action: pan-y;
  }
  .app {
    width: 100%;
    max-width: 900px;
    overflow-x: hidden;
  }
  header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 10px;
  }
  h1 {
    margin: 0;
    font-size: 20px;
  }
  .card {
    background: var(--card);
    border-radius: 12px;
    padding: 14px;
    box-shadow: 0 8px 24px rgba(10, 10, 20, 0.06);
    overflow-x: hidden;
  }
  .controls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .controls { min-width: 0; }
  .controls > * { min-width: 0; }
  .players {
    margin-top: 12px;
    display: grid;
    gap: 8px;
  }
  
  input,
  select,
  button {
    font-size: 14px;
    max-width: 100%;
  }
  input[type=text],
  input[type=number] {
    padding: 8px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    width: 100%;
    max-width: 200px;
  }
  button {
    padding: 8px 10px;
    border-radius: 8px;
    border: 0;
    background: var(--accent);
    color: #fff;
    cursor: pointer;
    white-space: normal;
    overflow-wrap: anywhere;
  }
  button.ghost {
    background: transparent;
    color: var(--accent);
    border: 2px solid var(--accent);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
    table-layout: fixed;
  }
  th, td {
    padding: 10px;
    text-align: left;
    border-bottom: 1px solid #f1f5f9;
    white-space: normal;
    word-break: break-word;
    hyphens: auto;
  }
  .score {
    font-weight: 700;
    font-size: 18px;
  }
  .crosses {
    font-size: 18px;
    color: #d9534f;
  }
  .chips { display: flex; gap: 6px; flex-wrap: wrap; }
  .chip { padding: 2px 8px; border-radius: 999px; background: #eef2f7; color: #0f172a; font-size: 12px; }
  .chip.neg { background: #fee2e2; color: #991b1b; }
  .actions {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
  }
  .actions { min-width: 0; }
  .actions > * { min-width: 0; }
  .small {
    padding: 6px 8px;
  }
  footer {
    margin-top: 12px;
    color: var(--muted);
    font-size: 13px;
  }

  @media (max-width: 640px) {
    body {
      padding: 10px;
    }
    h1 {
      font-size: 18px;
    }
    .controls, 
    .actions {
      width: 100%;
      justify-content: flex-start;
    }
    .controls button,
    .actions button {
      flex: 1 1 auto;
    }
    table {
      font-size: 13px;
    }
    th, td {
      padding: 8px;
    }
    input[type=text],
    input[type=number],
    select {
      max-width: 100%;
    }
  }
</style>

</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div>
          <h1>Compteur 10 000 — Partie</h1>
        </div>
        <div class="controls">
          <button id="newGame" class="ghost small">Nouvelle partie</button>
        </div>
      </header>

      <section>
        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center">
          <input id="playerNameInput" type="text" placeholder="Nom du joueur" />
          <button id="addPlayer" class="small">Ajouter joueur</button>
          <label style="color:var(--muted);font-size:13px">Joueur courant :</label>
          <select id="currentSelect"></select>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="pointsInput" type="number" value="100" min="1" style="width:120px;padding:8px;border-radius:8px;border:1px solid #e5e7eb;text-align:center" />
          <button id="addPoints" class="small">Ajouter points</button>
          <button id="noPoints" class="small ghost">Pas de points (ajouter une croix)</button>
          <button id="endTurn" class="small">Terminer le tour</button>
        </div>

        <table aria-label="Tableau des joueurs" style="margin-top:12px">
          <thead>
            <tr>
              <th style="width: 28%">Joueur</th>
              <th>Score</th>
              <th>Dernier ajout</th>
              <th>Croix (max 3)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="playersTbody"></tbody>
        </table>

        

      </section>

      <footer>
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div id="status" style="color:var(--muted)"></div>
        </div>
      </footer>
    </div>
  </div>

  <script>
    (function(){
      const STORAGE_KEY = 'compteur10000_game_v2';
      const COLOR_PALETTE = [
        { name: 'Rouge', value: '#ef4444' },
        { name: 'Ambre', value: '#f59e0b' },
        { name: 'Émeraude', value: '#10b981' },
        { name: 'Bleu', value: '#3b82f6' },
        { name: 'Violet', value: '#8b5cf6' },
        { name: 'Rose', value: '#ec4899' },
        { name: 'Sarcelle', value: '#14b8a6' },
        { name: 'Orange', value: '#f97316' },
        { name: 'Vert', value: '#22c55e' },
        { name: 'Pourpre', value: '#a855f7' }
      ];

      // DOM
      const playerNameInput = document.getElementById('playerNameInput');
      const addPlayerBtn = document.getElementById('addPlayer');
      const playersTbody = document.getElementById('playersTbody');
      const currentSelect = document.getElementById('currentSelect');
      const pointsInput = document.getElementById('pointsInput');
      const addPointsBtn = document.getElementById('addPoints');
      const noPointsBtn = document.getElementById('noPoints');
      const endTurnBtn = document.getElementById('endTurn');
      const newGameBtn = document.getElementById('newGame');
      const statusEl = document.getElementById('status');

      // game state
      let game = {
        players: [], // {id,name,score,crosses,lockedCrosses:boolean,color,history:number[]}
        currentIndex: 0,
        finished: false
      };

      function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(game)); }
      function load(){
        try{
          const s = localStorage.getItem(STORAGE_KEY);
          if(s) game = JSON.parse(s);
          migrateGame();
          save();
        }catch(e){ console.error(e); }
      }

      function uid(){ return Math.random().toString(36).slice(2,9); }

      function defaultColor(index){ return COLOR_PALETTE[index % COLOR_PALETTE.length].value; }
      function pushHistory(player, delta){
        if(!Array.isArray(player.history)) player.history = [];
        player.history.unshift(delta);
        if(player.history.length>8) player.history.pop();
      }

      function migrateGame(){
        if(!Array.isArray(game.players)) game.players = [];
        game.players.forEach((p, i)=>{
          if(typeof p.crosses !== 'number') p.crosses = 0;
          if(typeof p.lockedCrosses !== 'boolean') p.lockedCrosses = false;
          if(!p.color) p.color = defaultColor(i);
          if(!Array.isArray(p.history)) p.history = [];
        });
      }

      function addPlayer(name){
        if(!name) return;
        const i = game.players.length;
        game.players.push({id:uid(), name:name.trim(), score:0, crosses:0, lockedCrosses:false, color: defaultColor(i), history: []});
        render(); save();
      }

      function removePlayer(id){ game.players = game.players.filter(p=>p.id!==id); if(game.currentIndex>=game.players.length) game.currentIndex=0; render(); save(); }

      function setCurrentByIndex(i){ if(i<0) i=0; if(i>=game.players.length) i=0; game.currentIndex = i; render(); save(); }

      function render(){
        // select
        currentSelect.innerHTML = '';
        game.players.forEach((p,i)=>{
          const o = document.createElement('option'); o.value = i; o.textContent = (i+1)+'. '+p.name; if(i===game.currentIndex) o.selected=true; currentSelect.appendChild(o);
        });

        // table
        playersTbody.innerHTML = '';
        game.players.forEach((p,i)=>{
          const tr = document.createElement('tr');
          const nameTd = document.createElement('td');
          const nameSpan = document.createElement('span'); nameSpan.textContent = p.name + (i===game.currentIndex? ' ←' : '');
          nameTd.appendChild(nameSpan);
          const scoreTd = document.createElement('td'); scoreTd.innerHTML = '<span class="score">'+p.score+'</span>';
          const histTd = document.createElement('td');
          const chips = document.createElement('div'); chips.className='chips';
          const last = (p.history && p.history.length>0) ? p.history[0] : null;
          if(last !== null){
            const c = document.createElement('span'); c.className = 'chip' + (last<0?' neg':''); c.textContent = (last>0?'+':'')+last; chips.appendChild(c);
          }
          histTd.appendChild(chips);
          const crossesTd = document.createElement('td'); crossesTd.innerHTML = '<span class="crosses">'+'✕'.repeat(p.crosses)+'</span>' + (p.lockedCrosses? ' (penalité appliquée)':'');
          const actionsTd = document.createElement('td');
          const btns = document.createElement('div'); btns.className='actions';

          const selBtn = document.createElement('button'); selBtn.className='small ghost'; selBtn.textContent='Jouer'; selBtn.style.background = 'transparent'; selBtn.style.color = p.color; selBtn.style.border = '2px solid '+(p.color||defaultColor(i)); selBtn.onclick = ()=>{ setCurrentByIndex(i); };
          const editBtn = document.createElement('button'); editBtn.className='small'; editBtn.textContent='Renommer'; editBtn.style.background = p.color; editBtn.onclick = ()=>{ const n=prompt('Nom du joueur', p.name); if(n!==null){ p.name=n.trim(); render(); save(); }};
          const delBtn = document.createElement('button'); delBtn.className='small ghost'; delBtn.textContent='Supprimer'; delBtn.style.background = 'transparent'; delBtn.style.color = p.color; delBtn.style.border = '2px solid '+(p.color||defaultColor(i)); delBtn.onclick= ()=>{ if(confirm('Supprimer joueur '+p.name+' ?')){ removePlayer(p.id); }};
          const adjustBtn = document.createElement('button'); adjustBtn.className='small'; adjustBtn.textContent='Corriger'; adjustBtn.style.background = p.color; adjustBtn.onclick = ()=>{
            const v = prompt('Nouveau score pour '+p.name+' (peut être négatif) :', String(p.score));
            if(v===null) return; const n = parseInt(v,10); if(Number.isNaN(n)) return alert('Valeur invalide');
            if(n>10000){ return alert('Le score ne peut pas dépasser 10 000.'); }
            const delta = n - p.score; p.score = n; if(delta!==0) pushHistory(p, delta); save(); render();
          };
          const colorSelect = document.createElement('select');
          colorSelect.title = 'Couleur';
          COLOR_PALETTE.forEach(entry=>{
            const opt = document.createElement('option'); opt.value = entry.value; opt.textContent = entry.name; opt.style.color = entry.value; colorSelect.appendChild(opt);
          });
          colorSelect.value = p.color || defaultColor(i);
          colorSelect.onchange = (e)=>{ p.color = e.target.value; save(); render(); };

          btns.appendChild(selBtn); btns.appendChild(editBtn); btns.appendChild(adjustBtn); btns.appendChild(colorSelect); btns.appendChild(delBtn);
          actionsTd.appendChild(btns);

          tr.appendChild(nameTd);tr.appendChild(scoreTd);tr.appendChild(histTd);tr.appendChild(crossesTd);tr.appendChild(actionsTd);
          playersTbody.appendChild(tr);
        });

        // status
        if(game.finished){ statusEl.textContent = 'Partie terminée — Gagnant : '+(game.players[game.currentIndex]?game.players[game.currentIndex].name:'?'); }
        else if(game.players.length===0) statusEl.textContent = 'Aucun joueur — ajoute des joueurs pour commencer.';
        else statusEl.textContent = 'Au tour de : '+game.players[game.currentIndex].name;

        // appliquer la couleur aux contrôles de points selon le joueur courant
        applyControlsStyle();
      }

      function applyControlsStyle(){
        const hasPlayers = game.players && game.players.length>0;
        if(!hasPlayers){
          addPointsBtn.style.background = '';
          addPointsBtn.style.color = '';
          addPointsBtn.style.border = '';
          endTurnBtn.style.background = '';
          endTurnBtn.style.color = '';
          endTurnBtn.style.border = '';
          noPointsBtn.style.background = 'transparent';
          noPointsBtn.style.color = '';
          noPointsBtn.style.border = '';
          pointsInput.style.borderColor = '';
          return;
        }
        const current = game.players[game.currentIndex];
        const col = current.color || defaultColor(game.currentIndex);
        addPointsBtn.style.background = col;
        addPointsBtn.style.color = '#fff';
        addPointsBtn.style.border = '0';
        endTurnBtn.style.background = col;
        endTurnBtn.style.color = '#fff';
        endTurnBtn.style.border = '0';
        noPointsBtn.style.background = 'transparent';
        noPointsBtn.style.color = col;
        noPointsBtn.style.border = '2px solid '+col;
        pointsInput.style.borderColor = col;
      }

      // game logic
      function applyAddPoints(points){
        if(game.finished) return alert('La partie est terminée. Nouvelle partie pour rejouer.');
        if(game.players.length===0) return alert('Pas de joueur.');
        const p = game.players[game.currentIndex];
        const would = p.score + points;
        if(would>10000){ // rule: if it would exceed, mark 0 points for this turn; no cross added
          alert('Cet ajout ferait dépasser 10 000 — le joueur ne marque pas de points ce tour (aucune croix ajoutée).');
          // do not change score, do not add cross
          return;
        }
        // normal add
        p.score = would;
        pushHistory(p, points);
        save(); render();
        // check winning (must be exactly 10000)
        if(p.score===10000){ game.finished = true; save(); render(); alert('🎉 '+p.name+' a atteint 10 000 et gagne la partie !'); }
      }

      function applyNoPoints(){
        if(game.finished) return alert('La partie est terminée.');
        if(game.players.length===0) return alert('Pas de joueur.');
        const p = game.players[game.currentIndex];
        if(p.crosses>=3) return alert('Ce joueur a déjà 3 croix.');
        p.crosses = Math.min(3, p.crosses+1);
        // if crosses reach 3 and penalty not yet applied -> apply -1000 immediately (score peut devenir négatif)
        if(p.crosses===3 && !p.lockedCrosses){
          p.score = p.score - 1000;
          pushHistory(p, -1000);
          p.lockedCrosses = true; // ensure penalty only once
          alert(p.name + ' a atteint 3 croix → -1000 points appliqués.');
        }
        save(); render();
      }

      function endTurn(){
        if(game.finished) return alert('La partie est terminée.');
        if(game.players.length===0) return;
        // advance currentIndex
        game.currentIndex = (game.currentIndex + 1) % game.players.length;
        save(); render();
      }

      // buttons
      addPlayerBtn.addEventListener('click', ()=>{ addPlayer(playerNameInput.value||'Joueur'); playerNameInput.value=''; });
      currentSelect.addEventListener('change', ()=>{ setCurrentByIndex(parseInt(currentSelect.value,10)); applyControlsStyle(); });
      addPointsBtn.addEventListener('click', ()=>{ const v = parseInt(pointsInput.value||'0',10)||0; if(v<=0) return; applyAddPoints(v); });
      noPointsBtn.addEventListener('click', ()=>{ applyNoPoints(); });
      endTurnBtn.addEventListener('click', ()=>{ endTurn(); });
      newGameBtn.addEventListener('click', ()=>{ if(confirm('Commencer une nouvelle partie ? (toute progression sera perdue)')){ game = {players:[],currentIndex:0,finished:false}; localStorage.removeItem(STORAGE_KEY); render(); }});

      

      // keyboard shortcuts (optionnel)
      window.addEventListener('keydown', (e)=>{
        if(e.key==='Enter') addPointsBtn.click();
        if(e.key===' ') noPointsBtn.click();
      });

      // init
      load(); render();

      // service worker
      if('serviceWorker' in navigator){ navigator.serviceWorker.register('/sw.js').then(()=>console.log('SW reg')).catch(()=>console.log('SW fail')); }

    })();
  </script>
</body>
</html>